<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formularz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script type="module" src="base64.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        canvas {
            border: 2px solid #007bff;
            background-color: #fff;
            cursor: crosshair;
            border-radius: 5px;
        }
        .centered {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Tytuł</h1>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="form-container">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-3" placeholder="Imię">
                            <input type="text" class="form-control mb-3" placeholder="Nazwisko">
                            <input type="email" class="form-control mb-3" placeholder="Email">
                            <input type="text" class="form-control mb-3" placeholder="Ulica">
                            <input type="text" class="form-control mb-3" placeholder="Numer domu">
                            <input type="text" class="form-control mb-3" placeholder="Miasto (miejsce zawarcia umowy)">
                            <select id="selection" class="form-control mb-3" placeholder="Forma Płatności">
                                <option value="Gotówki">Płatność gotówką</option>
                                <option value="Przelewu">Płatność przelewem</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-3" placeholder="Kod pocztowy">
                            <input type="text" class="form-control mb-3" placeholder="Nazwa towaru">
                            <input type="number" class="form-control mb-3" placeholder="Ilość">
                            <input type="number" class="form-control mb-3" placeholder="Cena pojedyncza" step="0.01">
                            <input type="text" class="form-control mb-3" placeholder="Cena słownie">
                            <input type="date" class="form-control mb-3 text-center">
                            <input type="text" maxlength="100" class="form-control mb-3" placeholder="Uwagi">
                        </div>
                    </div>
                    <div class="centered">
                        <label for="drawingArea" class="form-label">Podpis</label>
                        <canvas id="drawingArea" width="400" height="400"></canvas>
                        <div class="mt-3">
                            <button class="btn btn-danger" onclick="clearCanvas()">Wyczyść</button>
                            <button class="btn btn-primary" onclick="generatePDF()">Wyślij</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ukryty szablon PDF -->
    <div id="pdf-content" style="display:none; padding: 20px; width: 210mm; height: 297mm; font-size: 16px;">
        <h1>Certyfikat</h1>
        <p>Imię i nazwisko: <span id="pdf-name"></span></p>
        <p>Data urodzenia: <span id="pdf-dob"></span></p>
        <p>Dziękujemy za skorzystanie z naszych usług.</p>
    </div>

    <script>
        import { base64Image } from "base64.js";
        import { robotoBase64 } from "base64.js";

        const canvas = document.getElementById("drawingArea");
        const ctx = canvas.getContext("2d");
        let drawing = false;
        let lastX = 0, lastY = 0;

        // Obsługa myszy
        canvas.addEventListener("mousedown", (event) => {
            drawing = true;
            [lastX, lastY] = [event.offsetX, event.offsetY];
        });
        canvas.addEventListener("mouseup", () => drawing = false);
        canvas.addEventListener("mouseleave", () => drawing = false);
        canvas.addEventListener("mousemove", draw);

        // Obsługa dotyku
        canvas.addEventListener("touchstart", (event) => {
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
            drawing = true;
        });

        canvas.addEventListener("touchend", () => drawing = false);
        canvas.addEventListener("touchcancel", () => drawing = false);
        canvas.addEventListener("touchmove", (event) => {
            event.preventDefault(); // Zapobiega przewijaniu strony podczas rysowania
            if (!drawing) return;
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            draw({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
        });

        function draw(event) {
            if (!drawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(event.offsetX, event.offsetY);
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.stroke();
            [lastX, lastY] = [event.offsetX, event.offsetY];
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function readSingleFile(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                var contents = e.target.result;
                displayContents(contents);
            };
            reader.readAsText(file);
        }

        // Funkcja generująca PDF
        window.generatePDF = async function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let data = document.querySelectorAll(".form-control");
            let isValid = true;
            let missingFields = [];
        
            data.forEach(input => input.style.border = "1px solid #ced4da");
        
            data.forEach(input => {
                if (input.value.trim() === "" && input.placeholder != "Uwagi") {
                    isValid = false;
                    input.style.border = "2px solid red";
                    missingFields.push(input.placeholder);
                }
            });
        
            if (!isValid) {
                alert("Proszę uzupełnić wszystkie pola!");
                return;
            }
        
            let signatureCanvas = document.getElementById("drawingArea");
            let signatureDataUrl = signatureCanvas ? signatureCanvas.toDataURL("image/png") : null;
        
            try {
                //const robotoBase64 = "";
                doc.addFileToVFS("Roboto-Regular.ttf", robotoBase64);
                doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                doc.setFont("Roboto", "normal");
            } catch (error) {
                console.warn("Nie udało się załadować czcionki Roboto, używam domyślnej.");
                doc.setFont("helvetica", "normal");
            }
    
            // Tytuł
            doc.setFontSize(20);
            doc.text("UMOWA KUPNA - SPRZEDAŻY", 105, 20, { align: "center" });

            // dane
            doc.setFontSize(12);
            doc.text(`Umowa zawarta w dniu: ${data[12].value}, pomiędzy:`, 20, 40);

            doc.text(`Panem(ią): ${data[0].value} ${data[1].value}`, 20, 50);
            doc.text(`Adres: ${data[3].value} ${data[4].value}, ${data[5].value}, ${data[7].value}`, 20, 55);
            doc.text(`Email: ${data[2].value}`, 20, 60);
            
            doc.text("zwanym dalej: 'sprzedawcą' a", 20, 70);

            doc.text("Black Light Invest sp. z o.o.,", 20, 80);
            doc.setFontSize(10);
            doc.text("Ul. Brukowa 8 91-341 Łódź, NIP: 9472015077, REGON: 540140591, KRS:0001137427", 20, 85);
            doc.setFontSize(12);

            doc.text("zwanym dalej: 'kupującym'", 20, 95);
            doc.text("o następującej treści:", 20, 100);

            // §1
            doc.setFont("Roboto", "bold");
            doc.text("§1", 105, 115, { align: "center" });
            doc.setFont("Roboto", "normal");

            // Tabela
            doc.text("Sprzedawca sprzedaje, a Kupujący kupuje następujące przedmioty/ rzeczy:", 20, 125);

            doc.autoTable({
                startY: 130,
                head: [["Lp.", "Nazwa / gatunek", "Ilość (szt)", "Cena (PLN)", "Uwagi"]],
                body: [[1, data[8].value, data[9].value, data[10].value, data[13].value]],
                theme: "grid",
                styles: { font: "Roboto", fontSize: 10 },
                tableWidth: 170, // Wymuszona szerokość tabeli
                margin: { left: 20 }, // Odsunięcie od lewej, by pasowało do tekstu
                columnStyles: {
                    0: { cellWidth: 10 },  // Lp.
                    1: { cellWidth: 65 },  // Nazwa / gatunek
                    2: { cellWidth: 20 },  // Ilość (szt)
                    3: { cellWidth: 20 },  // Cena (PLN)
                    4: { cellWidth: 55 }   // Uwagi
                }
            });

            const finalY = doc.autoTable.previous.finalY || 140;

            doc.text(`Łączna kwota: ${(data[9].value * data[10].value).toFixed(2)} PLN`, 20, finalY + 10);
            doc.text(`Słownie: ${data[11].value} złotych`, 20, finalY + 15);

            // §2
            doc.setFont("Roboto", "bold");
            doc.text("§ 2", 105, finalY + 30, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("Sprzedawca oświadcza, że w/w rzecz(y) stanowi(ą) jego własność i nie jest(są) obciążona(e) prawami na rzecz osób trzecich.", 20, finalY + 40, { maxWidth: 170 });

            // §3
            doc.setFont("Roboto", "bold");
            doc.text("§ 3", 105, finalY + 60, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text(`Kupujący zapłacił/a Sprzedawcy cenę w wysokości ${(data[9].value * data[10].value).toFixed(2)} zł`, 20, finalY + 70);
            doc.text(`Słownie: ${data[10].value} złotych`, 20, finalY + 75);
            doc.text(`Zapłata nastąpi/ła w formie: ${(data[6].value)}`, 20, finalY + 80);

            // §4
            doc.setFont("Roboto", "bold");
            doc.text("§ 4", 105, finalY + 95, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("Sprzedawca udzieli Kupującemu wszystkich niezbędnych informacji o stosunkach prawnych i faktycznych dotyczących Rzeczy. Sprzedawca wyda Kupującemu wszystkie posiadane dokumenty dotyczące Rzeczy, niezbędne do prawidłowego korzystania z niej.", 20, finalY + 105, { maxWidth: 170 });



            // Druga strona
            doc.addPage();

            // Ustawienie czcionki i rozmiaru dla drugiej strony
            doc.setFont("Roboto", "normal");
            doc.setFontSize(12);           

            // §5
            doc.setFont("Roboto", "bold");
            doc.text("§ 5", 105, 30, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("W sprawach nieuregulowanych niniejszą umową mają zastosowanie przepisy kodeksu cywilnego.", 20, 40, { maxWidth: 170 });

            // §6
            doc.setFont("Roboto", "bold");
            doc.text("§ 6", 105, 55, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("W sprawach nieuregulowanych niniejszą umową mają zastosowanie przepisy kodeksu cywilnego.", 20, 65, { maxWidth: 170 });

            // §7
            doc.setFont("Roboto", "bold");
            doc.text("§ 7", 105, 80, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("Zmiana umowy wymaga formy pisemnej pod rygorem nieważności.", 20, 90, { maxWidth: 170 });

            // §8
            doc.setFont("Roboto", "bold");
            doc.text("§ 8", 105, 105, { align: "center" });
            doc.setFont("Roboto", "normal");
            doc.text("Umowę sporządzono w dwóch jednobrzmiących egzemplarzach, po jednym dla każdej ze stron.", 20, 115, { maxWidth: 170 });

            doc.text("Podpis Sprzedawcy:", 20, 230);
            if (signatureDataUrl) {
                doc.addImage(signatureDataUrl, "PNG", 20, 235, 60, 60);
            }
            
            doc.text("Podpis Kupującego:", 140, 230);
            //let base64Image = ""

            doc.addImage(base64Image, "PNG", 140, 235, 60, 60);

            doc.save("umowa_kupna_sprzedazy.pdf");
            };
    </script>
</body>
</html>
